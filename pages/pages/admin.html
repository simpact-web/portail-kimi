<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simpact - Administration</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../modules/simpact-theme.css">
    <style>
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-xl);
        }
        
        .tabs {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--space-md);
        }
        
        .tab-btn {
            padding: var(--space-sm) var(--space-lg);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .price-table {
            width: 100%;
            margin-bottom: var(--space-lg);
        }
        
        .price-table th,
        .price-table td {
            padding: var(--space-sm);
            text-align: left;
        }
        
        .price-table input {
            width: 100px;
            padding: var(--space-sm);
        }
        
        .users-table {
            width: 100%;
        }
        
        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .role-superadmin { background: rgba(239, 68, 68, 0.2); color: var(--color-danger); }
        .role-admin { background: rgba(245, 158, 11, 0.2); color: var(--color-warning); }
        .role-production { background: rgba(59, 130, 246, 0.2); color: var(--color-info); }
        .role-commercial { background: rgba(139, 92, 246, 0.2); color: var(--color-secondary); }
        .role-compta { background: rgba(16, 185, 129, 0.2); color: var(--color-success); }
        .role-client { background: var(--bg-tertiary); color: var(--text-secondary); }
        
        @media (max-width: 1024px) {
            .admin-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>‚öôÔ∏è Administration</h1>
                <p class="header-subtitle">Gestion des prix et utilisateurs</p>
            </div>
            <div style="display: flex; gap: var(--space-md); align-items: center;">
                <span class="user-badge" id="user-name">--</span>
                <button class="btn btn-secondary" onclick="window.location.href='../dashboard.html'">
                    üìä Dashboard
                </button>
                <button class="btn btn-danger" onclick="logout()">D√©connexion</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('prices')">üí∞ Tarifs</button>
            <button class="tab-btn" onclick="switchTab('users')">üë• Utilisateurs</button>
            <button class="tab-btn" onclick="switchTab('config')">‚öôÔ∏è Configuration</button>
        </div>

        <!-- Onglet Prix -->
        <div id="tab-prices" class="tab-content active">
            <div class="admin-grid">
                <div class="card">
                    <h3 class="card-title">Flyers</h3>
                    <table class="price-table">
                        <thead>
                            <tr>
                                <th>Qt√© Max</th>
                                <th>Prix Recto</th>
                                <th>Prix R/V</th>
                            </tr>
                        </thead>
                        <tbody id="flyer-table"></tbody>
                    </table>
                    <button class="btn btn-primary btn-sm" onclick="addPriceRow('flyer')">+ Ajouter palier</button>
                </div>

                <div class="card">
                    <h3 class="card-title">Cartes de visite</h3>
                    <table class="price-table">
                        <thead>
                            <tr>
                                <th>Qt√© Max</th>
                                <th>Prix Standard</th>
                                <th>Prix Pellicul√©</th>
                            </tr>
                        </thead>
                        <tbody id="carte-table"></tbody>
                    </table>
                    <button class="btn btn-primary btn-sm" onclick="addPriceRow('carte')">+ Ajouter palier</button>
                </div>

                <div class="card">
                    <h3 class="card-title">Prix Fixes</h3>
                    <div class="form-group">
                        <label>Co√ªt Pelliculage (par unit√©)</label>
                        <input type="number" id="prix-pelliculage" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Co√ªt Feuille N&B (Livre)</label>
                        <input type="number" id="prix-feuille-nb" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Suppl√©ment Offset 100g</label>
                        <input type="number" id="prix-offset-100" step="0.001">
                    </div>
                    <div class="form-group">
                        <label>Co√ªt par gramme papier couch√©</label>
                        <input type="number" id="prix-gramme-couche" step="0.0001">
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Couvertures Livres</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>A4 Recto</label>
                            <input type="number" id="livre-a4-recto" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>A4 R/V</label>
                            <input type="number" id="livre-a4-rectoverso" step="0.01">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>A5 Recto</label>
                            <input type="number" id="livre-a5-recto" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>A5 R/V</label>
                            <input type="number" id="livre-a5-rectoverso" step="0.01">
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: var(--space-xl); text-align: center;">
                <button class="btn btn-success btn-lg" onclick="savePrices()">
                    üíæ SAUVEGARDER LES PRIX
                </button>
                <button class="btn btn-secondary" onclick="exportConfig()" style="margin-left: var(--space-md);">
                    üì• Exporter JSON
                </button>
            </div>
        </div>

        <!-- Onglet Utilisateurs -->
        <div id="tab-users" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                    <h3 class="card-title" style="margin: 0;">Liste des utilisateurs</h3>
                    <button class="btn btn-primary" onclick="openUserModal()">+ Ajouter utilisateur</button>
                </div>
                
                <div class="table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Identifiant</th>
                                <th>Nom</th>
                                <th>R√¥le</th>
                                <th>Page par d√©faut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Onglet Configuration -->
        <div id="tab-config" class="tab-content">
            <div class="card">
                <h3 class="card-title">Maintenance</h3>
                <div style="display: grid; gap: var(--space-md);">
                    <button class="btn btn-danger" onclick="resetOrders()">
                        üóëÔ∏è Vider toutes les commandes
                    </button>
                    <button class="btn btn-danger" onclick="resetStock()">
                        üóëÔ∏è Vider le stock papier
                    </button>
                    <button class="btn btn-secondary" onclick="resetUsers()">
                        üîÑ R√©initialiser utilisateurs (d√©faut)
                    </button>
                </div>
                
                <div style="margin-top: var(--space-xl); padding: var(--space-lg); background: var(--bg-tertiary); border-radius: var(--radius-md);">
                    <h4 style="margin-bottom: var(--space-md);">üìä Statistiques Syst√®me</h4>
                    <p>Commandes stock√©es: <strong id="stats-orders">0</strong></p>
                    <p>Types de papier: <strong id="stats-papers">0</strong></p>
                    <p>Utilisateurs: <strong id="stats-users">0</strong></p>
                    <p>Taille donn√©es: <strong id="stats-size">0 KB</strong></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Utilisateur -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Ajouter / Modifier Utilisateur</h3>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="user-form" onsubmit="event.preventDefault(); saveUser();">
                    <input type="hidden" id="user-original-id">
                    
                    <div class="form-group">
                        <label>Identifiant de connexion *</label>
                        <input type="text" id="user-id" placeholder="Ex: comm02" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Mot de passe *</label>
                        <input type="text" id="user-pass" placeholder="Ex: motdepasse123" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Nom d'affichage *</label>
                        <input type="text" id="user-name-input" placeholder="Ex: Commercial 2" required>
                    </div>
                    
                    <div class="form-group">
                        <label>R√¥le *</label>
                        <select id="user-role" required>
                            <option value="">-- S√©lectionner --</option>
                            <option value="superadmin">üî¥ Super Admin</option>
                            <option value="admin">üü† Admin</option>
                            <option value="production">üîµ Production</option>
                            <option value="commercial">üü£ Commercial</option>
                            <option value="compta">üü¢ Comptabilit√©</option>
                            <option value="client">‚ö™ Client</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Page de redirection *</label>
                        <select id="user-redirect" required>
                            <option value="../dashboard.html">Dashboard</option>
                            <option value="commercial.html">Commercial</option>
                            <option value="production.html">Production</option>
                            <option value="compta.html">Comptabilit√©</option>
                            <option value="client.html">Client</option>
                            <option value="admin.html">Admin</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                        <button type="submit" class="btn btn-success btn-block">üíæ Enregistrer</button>
                        <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Annuler</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../modules/simpact-core.js"></script>
    <script>
        const user = SimpactCore.auth.checkAuth(['admin', 'superadmin']);
        document.getElementById('user-name').textContent = user.name;

        let priceConfig = null;

        // Chargement initial
        async function loadData() {
            // Charger prix
            try {
                const response = await fetch('../prix_config.json');
                priceConfig = await response.json();
                renderPrices();
            } catch (e) {
                console.error('Erreur chargement prix:', e);
            }
            
            renderUsers();
            updateStats();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
            
            if (tab === 'config') updateStats();
        }

        // === GESTION PRIX ===

        function renderPrices() {
            if (!priceConfig) return;
            
            // Flyers
            const flyerBody = document.getElementById('flyer-table');
            flyerBody.innerHTML = priceConfig.tarifs.flyer.recto.map((item, i) => `
                <tr>
                    <td><input type="number" value="${item.qty}" class="flyer-qty-${i}"></td>
                    <td><input type="number" value="${item.price}" step="0.01" class="flyer-recto-${i}"></td>
                    <td><input type="number" value="${priceConfig.tarifs.flyer.rectoVerso[i]?.price || 0}" step="0.01" class="flyer-rv-${i}"></td>
                </tr>
            `).join('');

            // Cartes
            const carteBody = document.getElementById('carte-table');
            carteBody.innerHTML = priceConfig.tarifs.carte.recto.map((item, i) => `
                <tr>
                    <td><input type="number" value="${item.qty}" class="carte-qty-${i}"></td>
                    <td><input type="number" value="${item.price}" step="0.01" class="carte-recto-${i}"></td>
                    <td><input type="number" value="${priceConfig.tarifs.carte.pellicule[i]?.price || 0}" step="0.01" class="carte-pell-${i}"></td>
                </tr>
            `).join('');

            // Prix fixes
            document.getElementById('prix-pelliculage').value = priceConfig.prix_fixes.pelliculage;
            document.getElementById('prix-feuille-nb').value = priceConfig.prix_fixes.feuille_nb;
            document.getElementById('prix-offset-100').value = priceConfig.prix_fixes.offset_100;
            document.getElementById('prix-gramme-couche').value = priceConfig.prix_fixes.gramme_couche;

            // Livres
            document.getElementById('livre-a4-recto').value = priceConfig.prix_couverture_livre.a4.recto;
            document.getElementById('livre-a4-rectoverso').value = priceConfig.prix_couverture_livre.a4.rectoVerso;
            document.getElementById('livre-a5-recto').value = priceConfig.prix_couverture_livre.a5.recto;
            document.getElementById('livre-a5-rectoverso').value = priceConfig.prix_couverture_livre.a5.rectoVerso;
        }

        function addPriceRow(type) {
            // Simplifi√©: rechargera la page pour l'instant
            alert('Fonction √† impl√©menter: ajouter une ligne de prix ' + type);
        }

        function savePrices() {
            // Collecter les valeurs et cr√©er le nouveau JSON
            const newConfig = {
                ...priceConfig,
                prix_fixes: {
                    pelliculage: parseFloat(document.getElementById('prix-pelliculage').value),
                    feuille_nb: parseFloat(document.getElementById('prix-feuille-nb').value),
                    offset_100: parseFloat(document.getElementById('prix-offset-100').value),
                    gramme_couche: parseFloat(document.getElementById('prix-gramme-couche').value)
                },
                prix_couverture_livre: {
                    a4: {
                        recto: parseFloat(document.getElementById('livre-a4-recto').value),
                        rectoVerso: parseFloat(document.getElementById('livre-a4-rectoverso').value)
                    },
                    a5: {
                        recto: parseFloat(document.getElementById('livre-a5-recto').value),
                        rectoVerso: parseFloat(document.getElementById('livre-a5-rectoverso').value)
                    }
                },
                version: Date.now()
            };

            // T√©l√©chargement du fichier
            const blob = new Blob([JSON.stringify(newConfig, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'prix_config.json';
            a.click();
            
            alert('‚úÖ Configuration t√©l√©charg√©e ! Remplacez le fichier sur GitHub.');
        }

        function exportConfig() {
            savePrices();
        }

        // === GESTION UTILISATEURS ===

        function renderUsers() {
            const users = SimpactCore.auth.getAllUsers();
            const tbody = document.getElementById('users-table-body');
            
            tbody.innerHTML = users.map(u => {
                const roleClass = `role-${u.role}`;
                const roleNames = {
                    'superadmin': 'üî¥ Super Admin',
                    'admin': 'üü† Admin',
                    'production': 'üîµ Production',
                    'commercial': 'üü£ Commercial',
                    'compta': 'üü¢ Compta',
                    'client': '‚ö™ Client'
                };
                
                return `
                    <tr>
                        <td style="font-family: var(--font-mono); font-weight: 600;">${u.id}</td>
                        <td>${u.name}</td>
                        <td><span class="role-badge ${roleClass}">${roleNames[u.role] || u.role}</span></td>
                        <td>${u.redirect}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick='editUser(${JSON.stringify(u)})'>‚úèÔ∏è</button>
                            ${u.id !== 'youssef' ? `<button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}', '${u.name}')">üóëÔ∏è</button>` : '<span style="color: var(--text-muted); font-size: 0.8rem;">Prot√©g√©</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openUserModal() {
            document.getElementById('user-form').reset();
            document.getElementById('user-original-id').value = '';
            document.getElementById('user-modal').classList.add('active');
        }

        function closeUserModal() {
            document.getElementById('user-modal').classList.remove('active');
        }

        function editUser(user) {
            document.getElementById('user-original-id').value = user.id;
            document.getElementById('user-id').value = user.id;
            document.getElementById('user-pass').value = user.pass;
            document.getElementById('user-name-input').value = user.name;
            document.getElementById('user-role').value = user.role;
            document.getElementById('user-redirect').value = user.redirect;
            
            if (user.id === 'youssef') {
                document.getElementById('user-id').disabled = true;
                document.getElementById('user-role').disabled = true;
            } else {
                document.getElementById('user-id').disabled = false;
                document.getElementById('user-role').disabled = false;
            }
            
            document.getElementById('user-modal').classList.add('active');
        }

        function saveUser() {
            const originalId = document.getElementById('user-original-id').value;
            const userData = {
                id: document.getElementById('user-id').value.trim(),
                pass: document.getElementById('user-pass').value,
                name: document.getElementById('user-name-input').value.trim(),
                role: document.getElementById('user-role').value,
                redirect: document.getElementById('user-redirect').value
            };

            // V√©rifier doublon si nouveau
            if (!originalId) {
                const existing = SimpactCore.auth.getAllUsers().find(u => u.id === userData.id);
                if (existing) {
                    alert('‚ö†Ô∏è Cet identifiant existe d√©j√†');
                    return;
                }
            }

            // Supprimer l'ancien si changement d'ID
            if (originalId && originalId !== userData.id) {
                SimpactCore.auth.deleteUser(originalId);
            }

            SimpactCore.auth.saveUser(userData);
            closeUserModal();
            renderUsers();
            alert('‚úÖ Utilisateur enregistr√©');
        }

        function deleteUser(id, name) {
            if (!confirm(`Supprimer l'utilisateur "${name}" (${id}) ?`)) return;
            
            if (SimpactCore.auth.deleteUser(id)) {
                renderUsers();
                alert('‚úÖ Utilisateur supprim√©');
            }
        }

        // === MAINTENANCE ===

        function updateStats() {
            const orders = SimpactCore.orders.getAll();
            const stock = SimpactCore.stock.getAll();
            const users = SimpactCore.auth.getAllUsers();
            
            // Calcul taille donn√©es
            const dataSize = (
                JSON.stringify(localStorage).length / 1024
            ).toFixed(2);
            
            document.getElementById('stats-orders').textContent = orders.length;
            document.getElementById('stats-papers').textContent = stock.length;
            document.getElementById('stats-users').textContent = users.length;
            document.getElementById('stats-size').textContent = dataSize + ' KB';
        }

        function resetOrders() {
            if (!confirm('‚ö†Ô∏è Vider TOUTES les commandes ? Cette action est irr√©versible.')) return;
            localStorage.removeItem('SIMPACT_ORDERS');
            alert('‚úÖ Commandes effac√©es');
            updateStats();
        }

        function resetStock() {
            if (!confirm('‚ö†Ô∏è Vider le stock papier ?')) return;
            localStorage.removeItem('SIMPACT_STOCK');
            localStorage.removeItem('SIMPACT_STOCK_MOVEMENTS');
            alert('‚úÖ Stock effac√©');
            updateStats();
        }

        function resetUsers() {
            if (!confirm('‚ö†Ô∏è R√©initialiser les utilisateurs aux valeurs par d√©faut ?')) return;
            localStorage.removeItem('SIMPACT_USERS');
            alert('‚úÖ Utilisateurs r√©initialis√©s. Rechargez la page.');
            renderUsers();
        }

        // Fermer modal sur clic ext√©rieur
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Init
        loadData();
    </script>
</body>
</html>
