<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simpact - Atelier Production</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../modules/simpact-theme.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        .production-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-xl);
        }
        
        .machine-status {
            display: flex;
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }
        
        .machine-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            border: 2px solid var(--border-color);
            flex: 1;
            text-align: center;
        }
        
        .machine-card.active {
            border-color: var(--color-production);
            background: rgba(245, 158, 11, 0.1);
        }
        
        .machine-name {
            font-weight: 700;
            margin-bottom: var(--space-sm);
        }
        
        .machine-speed {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .machine-status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 700;
            margin-top: var(--space-sm);
        }
        
        .status-idle {
            background: var(--color-success);
            color: white;
        }
        
        .status-busy {
            background: var(--color-production);
            color: white;
        }
        
        .orders-grid {
            display: grid;
            gap: var(--space-lg);
        }
        
        .order-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            border-left: 5px solid var(--color-production);
            transition: all 0.2s;
        }
        
        .order-card:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-lg);
        }
        
        .order-card.done {
            border-left-color: var(--color-success);
            opacity: 0.7;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }
        
        .order-ref {
            font-family: var(--font-mono);
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .order-product {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: var(--space-xs);
        }
        
        .order-client {
            color: var(--color-production);
            font-weight: 600;
        }
        
        .order-specs {
            background: var(--bg-primary);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: var(--space-md) 0;
            white-space: pre-line;
            border: 1px dashed var(--border-color);
        }
        
        .order-actions {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-md);
        }
        
        .time-estimate {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: var(--space-sm);
        }
        
        .filter-bar {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 600;
        }
        
        .filter-btn.active {
            background: var(--color-production);
            color: white;
            border-color: var(--color-production);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="production-header">
            <div>
                <h1>üè≠ Atelier Production</h1>
                <p class="header-subtitle">Gestion de la file d'attente</p>
            </div>
            <div style="display: flex; gap: var(--space-md); align-items: center;">
                <span class="user-badge" id="user-name">--</span>
                <button class="btn btn-secondary" onclick="window.location.href='../dashboard.html'">
                    üìä Dashboard
                </button>
                <button class="btn btn-danger" onclick="logout()">D√©connexion</button>
            </div>
        </div>

        <!-- Simulateur de charge machines -->
        <div class="machine-status">
            <div class="machine-card active" id="machine-1">
                <div class="machine-name">Xerox Versant 280</div>
                <div class="machine-speed">80 ppm ‚Ä¢ A3+</div>
                <span class="machine-status-badge status-idle" id="status-1">DISPONIBLE</span>
            </div>
            <div class="machine-card" id="machine-2">
                <div class="machine-name">Canon C750</div>
                <div class="machine-speed">65 ppm ‚Ä¢ A3</div>
                <span class="machine-status-badge status-idle" id="status-2">DISPONIBLE</span>
            </div>
            <div class="machine-card" id="machine-3">
                <div class="machine-name">Konica C6085</div>
                <div class="machine-speed">85 ppm ‚Ä¢ SRA3</div>
                <span class="machine-status-badge status-idle" id="status-3">DISPONIBLE</span>
            </div>
        </div>

        <!-- Filtres -->
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterOrders('all')">Toutes</button>
            <button class="filter-btn" onclick="filterOrders('pending')">‚è≥ En attente</button>
            <button class="filter-btn" onclick="filterOrders('progress')">‚öôÔ∏è En cours</button>
            <button class="filter-btn" onclick="filterOrders('urgent')">üî• Urgent</button>
        </div>

        <!-- Liste des commandes -->
        <div id="orders-list" class="orders-grid">
            <p style="color: var(--text-muted); text-align: center; padding: var(--space-2xl);">
                Chargement des commandes...
            </p>
        </div>
    </div>

    <!-- Template PDF -->
    <div id="pdf-template" style="display: none; background: white; color: black; padding: 40px;">
        <div style="display: flex; justify-content: space-between; border-bottom: 3px solid #ea580c; padding-bottom: 20px; margin-bottom: 30px;">
            <div>
                <h1 style="color: #ea580c; margin: 0;">ORDRE DE FABRICATION</h1>
                <p>R√©f: <span id="pdf-ref"></span></p>
            </div>
            <div style="text-align: right;">
                <h2>SIMPACT</h2>
                <p>Atelier Production</p>
            </div>
        </div>
        <div style="margin-bottom: 30px; font-size: 1.1rem;">
            <strong>Client:</strong> <span id="pdf-client"></span><br>
            <strong>Produit:</strong> <span id="pdf-prod"></span><br>
            <strong>Quantit√©:</strong> <span id="pdf-qty" style="font-size: 1.3em; font-weight: bold;"></span>
        </div>
        <h3>üìã INSTRUCTIONS TECHNIQUES</h3>
        <div id="pdf-desc" style="border: 2px dashed #ea580c; padding: 20px; margin-top: 20px; white-space: pre-line;"></div>
    </div>

    <script src="../modules/simpact-core.js"></script>
    <script>
        const user = SimpactCore.auth.checkAuth(['production', 'admin', 'superadmin']);
        document.getElementById('user-name').textContent = user.name;

        let currentFilter = 'all';
        let orders = [];

        // Simulateur de charge machines
        const MACHINES = [
            { id: 1, name: 'Xerox Versant 280', speed: 80, status: 'idle' },
            { id: 2, name: 'Canon C750', speed: 65, status: 'idle' },
            { id: 3, name: 'Konica C6085', speed: 85, status: 'idle' }
        ];

        function estimateTime(order) {
            // Estimation simplifi√©e bas√©e sur la quantit√© et le produit
            const qty = parseInt(order.qty) || 0;
            let pages = qty;
            
            // Facteurs produits
            if (order.prod.includes('Brochure') || order.prod.includes('Livre')) {
                const match = order.desc.match(/(\d+)\s*Pages/);
                if (match) {
                    pages = qty * parseInt(match[1]) / 4; // Feuilles n√©cessaires
                }
            }
            
            // Trouver machine disponible la plus rapide
            const machine = MACHINES.find(m => m.status === 'idle') || MACHINES[0];
            const minutes = Math.ceil(pages / machine.speed) + 15; // +15min setup
            
            return { minutes, machine: machine.name };
        }

        function renderOrders() {
            orders = SimpactCore.orders.getAll();
            
            // Filtrer
            let filtered = orders;
            if (currentFilter === 'pending') {
                filtered = orders.filter(o => o.statusProd === 'En attente');
            } else if (currentFilter === 'progress') {
                filtered = orders.filter(o => o.statusProd === 'En production');
            } else if (currentFilter === 'urgent') {
                filtered = orders.filter(o => o.statusProd === 'En attente' && parseFloat(o.price) > 500);
            }
            
            // Exclure termin√©es sauf si explicitement demand√©
            if (currentFilter === 'all') {
                filtered = filtered.filter(o => o.statusProd !== 'Termin√©');
            }

            const container = document.getElementById('orders-list');
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: var(--space-2xl);">Aucune commande en attente üéâ</p>';
                return;
            }

            container.innerHTML = filtered.map(order => {
                const isDone = order.statusProd === 'Termin√©';
                const isProgress = order.statusProd === 'En production';
                const timeInfo = estimateTime(order);
                
                return `
                    <div class="order-card ${isDone ? 'done' : ''}">
                        <div class="order-header">
                            <div>
                                <div class="order-ref">#${order.ref}</div>
                                <div class="order-product">${order.prod}</div>
                                <div class="order-client">${order.client}</div>
                            </div>
                            <span class="badge ${isDone ? 'badge-success' : isProgress ? 'badge-warning' : 'badge-info'}">
                                ${order.statusProd}
                            </span>
                        </div>
                        
                        <div class="order-specs">${order.desc}</div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm);">
                            <strong>Qt√©: ${order.qty}</strong>
                            <span style="font-family: var(--font-mono); font-weight: 700; color: var(--color-primary);">
                                ${order.price} DT
                            </span>
                        </div>
                        
                        ${!isDone ? `
                        <div class="time-estimate">
                            ‚è±Ô∏è Estimation: ~${timeInfo.minutes} min sur ${timeInfo.machine}
                        </div>
                        ` : ''}
                        
                        <div class="order-actions">
                            <button class="btn btn-secondary" onclick="generatePDF('${order.ref}')">
                                üìÑ Fiche
                            </button>
                            ${!isDone ? `
                                ${!isProgress ? `
                                <button class="btn btn-primary" onclick="updateStatus('${order.ref}', 'En production')">
                                    ‚ñ∂Ô∏è D√©marrer
                                </button>
                                ` : `
                                <button class="btn btn-success" onclick="updateStatus('${order.ref}', 'Termin√©')">
                                    ‚úÖ Terminer
                                </button>
                                `}
                                <button class="btn btn-danger" onclick="updateStatus('${order.ref}', 'Annul√©e')">
                                    ‚ùå Annuler
                                </button>
                            ` : `
                                <button class="btn btn-ghost" onclick="updateStatus('${order.ref}', 'En attente')">
                                    ‚Ü©Ô∏è Rouvrir
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
            
            updateMachineStatus();
        }

        function updateMachineStatus() {
            // Simuler l'occupation des machines bas√©e sur les commandes "En production"
            const inProgress = orders.filter(o => o.statusProd === 'En production').length;
            
            MACHINES.forEach((m, i) => {
                m.status = i < inProgress ? 'busy' : 'idle';
                const card = document.getElementById(`machine-${i+1}`);
                const badge = document.getElementById(`status-${i+1}`);
                
                if (m.status === 'busy') {
                    card.classList.add('active');
                    badge.textContent = 'EN PRODUCTION';
                    badge.className = 'machine-status-badge status-busy';
                } else {
                    card.classList.remove('active');
                    badge.textContent = 'DISPONIBLE';
                    badge.className = 'machine-status-badge status-idle';
                }
            });
        }

        function filterOrders(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderOrders();
        }

        function updateStatus(ref, newStatus) {
            if (newStatus === 'Annul√©e' && !confirm('Confirmer l\'annulation ?')) return;
            
            SimpactCore.orders.updateStatus(ref, newStatus, 'prod');
            renderOrders();
            
            // Notification temps r√©el
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('simpact_orders');
                channel.postMessage({ type: 'STATUS_UPDATE', ref, status: newStatus });
            }
        }

        function generatePDF(ref) {
            const order = orders.find(o => o.ref === ref);
            if (!order) return;
            
            document.getElementById('pdf-ref').textContent = order.ref;
            document.getElementById('pdf-client').textContent = order.client;
            document.getElementById('pdf-prod').textContent = order.prod;
            document.getElementById('pdf-qty').textContent = order.qty;
            document.getElementById('pdf-desc').textContent = order.desc;
            
            const template = document.getElementById('pdf-template');
            template.style.display = 'block';
            
            const opt = {
                margin: 10,
                filename: `OF_${order.ref}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().from(template).set(opt).save().then(() => {
                template.style.display = 'none';
            });
        }

        // Temps r√©el
        if (typeof BroadcastChannel !== 'undefined') {
            const channel = new BroadcastChannel('simpact_orders');
            channel.onmessage = () => renderOrders();
        }

        // Initialisation
        renderOrders();
        setInterval(renderOrders, 5000);
    </script>
</body>
</html>
